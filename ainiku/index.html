<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>ainiku</title>
<script src="js/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="js/init.js" type="text/javascript"></script>
<script src="js/shcode.js" type="text/javascript"></script>
<link href="css/index.css" type="text/css" rel="stylesheet" />
<link href="css/css.css" type="text/css" rel="stylesheet" />
</head>

<body>
<div class="content">
<div id="leftdir" class="left">
<dl>
<dt><a href="javascript:;">公用函数</a></dt>
<dd><a href="#">首页</a></dd>
</dl>
</div>
<div id="rightdir" class="right">


<div class="function">
 <a name="is_login" class="mark"></a>
  <pre class="brush:js;toolbar:false">
    /**
     * 检测用户是否登录
     * @return integer 0-未登录，大于0-当前登录用户ID
     * @author 寞枫 <735579768@.qq.com>
     */
    function is_login(){
        $user = session('user_auth');
        if (empty($user)) {
            return 0;
        } else {
            return session('user_auth_sign') == data_auth_sign($user) ? $user['uid'] : 0;
        }
    }
 </pre>
 </div>
 
<div class="function">
    <a name="auto_login" class="mark"></a>
    <pre class="brush:js;toolbar:false">
    /**
     *前台自动登陆判断
     */
     function auto_login(){
            $user=cookie('token');
            if(empty($user)){session('user_auth',null);return 0;};
            $uid=is_login();
            if(!$uid)$uid=autologin();
            return $uid;
         }
    </pre>
</div>

<div class="function">
    <a name="loginout" class="mark"></a>
    <pre class="brush:js;toolbar:false">
    /**
     *前台用户自动登出
     */
     function loginout(){
         session('[destroy]');
         cookie(null);
        // cookie('token',null,array('expire'=>time()+(-1000)));
         }
    </pre>
</div>

<div class="function">
    <a name="autologin" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *前台用户判断cookie自动登陆
 */
 function autologin(){
	 $user=cookie('token');
	 if(empty($user)){
		 return 0;
		 }else{
		 $username=ainiku_decrypt($user['u']);
		 $password=ainiku_ucenter_md5(ainiku_decrypt($user['p']));
		 $map['uesrname']=$username;
		 $map['password']=$password;
		 $info=M('Member')->where($map)->find();
		 if(empty($info)){
			 return 0;
		  }else{
			/* 记录登录SESSION和COOKIES */
			$auth = array(
				'uid'             => $info['member_id'],
				'username'        => $info['username'],
				'last_login_time' => $info['last_login_time'],
			);
			session('user_auth', $auth);
			session('uinfo',$info);
			session('user_auth_sign', data_auth_sign($auth));
			define('UID',$info['member_id']);
			
			$uid=$info['member_id'];
			$ip=get_client_ip();
			$location=getIpLocation($ip);
			$data = array(
				'member_id'              => $uid,
				'update_time' => NOW_TIME,
				'last_login_ip'   =>$ip ,
				'last_login_adr'  =>$location['country'].$location['area']
			);
			M('Member')->where("member_id=$uid")->setInc('login');
			M('Member')->save($data);
			//保存用户登陆日志
			M('MemberLog')->add(
			array(
					'member_id'=>$uid,
					'ip'=>$Ip,
					'adr'=>$location['country'].$location['area'],
					'create_time'=>NOW_TIME
					)
			);
			return $uid;
			 
				 }			 
	}

	 }
    </pre>
</div>

<div class="function">
    <a name="check_verify" class="mark"></a>
    <pre class="brush:js;toolbar:false">
        /**
         * 检测验证码
         * @param  integer $id 验证码ID
         * @return boolean     检测结果
         * @author 寞枫 <735579768@.qq.com>
         */
        function check_verify($code, $id = 1){
            $verify = new \Think\Verify();
            return $verify->check($code, $id);
        }
    </pre>
</div>

<div class="function"> 
<a name="ainiku_encrypt"></a>
<pre class="brush:php;toolbar:false">
/**
 * 系统加密方法
 * @param string $data 要加密的字符串
 * @param string $key  加密密钥
 * @param int $expire  过期时间 单位 秒
 * @return string
 * @author 枫叶 <735579768@qq.com>
 */
function ainiku_encrypt($data, $key = 'adminrootkl', $expire = 0) {
    $key  = md5(empty($key) ? C('DATA_AUTH_KEY') : $key);
    $data = base64_encode($data);
    $x    = 0;
    $len  = strlen($data);
    $l    = strlen($key);
    $char = '';

    for ($i = 0; $i < $len; $i++) {
        if ($x == $l) $x = 0;
        $char .= substr($key, $x, 1);
        $x++;
    }

    $str = sprintf('%010d', $expire ? $expire + time():0);

    for ($i = 0; $i < $len; $i++) {
        $str .= chr(ord(substr($data, $i, 1)) + (ord(substr($char, $i, 1)))%256);
    }
    return str_replace(array('+','/','='),array('-','_',''),base64_encode($str));
}

</pre>
</div>

<div class="function">
<a name="ainiku_decrypt"></a>
<pre class="brush:php;toolbar:false">
/**
 * 系统解密方法
 * @param  string $data 要解密的字符串 （必须是ainiku_encrypt方法加密的字符串）
 * @param  string $key  加密密钥
 * @return string
 * @author 枫叶 <735579768@qq.com>
 */
function ainiku_decrypt($data, $key = 'adminrootkl'){
    $key    = md5(empty($key) ? C('DATA_AUTH_KEY') : $key);
    $data   = str_replace(array('-','_'),array('+','/'),$data);
    $mod4   = strlen($data) % 4;
    if ($mod4) {
       $data .= substr('====', $mod4);
    }
    $data   = base64_decode($data);
    $expire = substr($data,0,10);
    $data   = substr($data,10);

    if($expire > 0 && $expire < time()) {
        return '';
    }
    $x      = 0;
    $len    = strlen($data);
    $l      = strlen($key);
    $char   = $str = '';

    for ($i = 0; $i < $len; $i++) {
        if ($x == $l) $x = 0;
        $char .= substr($key, $x, 1);
        $x++;
    }

    for ($i = 0; $i < $len; $i++) {
        if (ord(substr($data, $i, 1))<ord(substr($char, $i, 1))) {
            $str .= chr((ord(substr($data, $i, 1)) + 256) - ord(substr($char, $i, 1)));
        }else{
            $str .= chr(ord(substr($data, $i, 1)) - ord(substr($char, $i, 1)));
        }
    }
    return base64_decode($str);
}
</pre>
</div>

<div class="function">
    <a name="ainiku_ucenter_md5" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
  *系统用户密码加密算法
  */
function ainiku_ucenter_md5($str, $key = ''){
	$key=$key?C('DATA_AUTH_KEY'):'adminrootkl';
    return '' === $str ? '' : md5(sha1($str) . $key);
}
    </pre>
</div>

<div class="function">
    <a name="data_auth_sign" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 数据签名认证
 * @param  array  $data 被认证的数据
 * @return string       签名
 * @author 寞枫 <735579768@qq.com>
 */
function data_auth_sign($data) {
    //数据类型检测
    if(!is_array($data)){
        $data = (array)$data;
    }
    ksort($data); //排序
    $code = http_build_query($data); //url编码并生成query字符串
    $sign = sha1($code); //生成签名
    return $sign;
}
    </pre>
</div>

<div class="function">
    <a name="api" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 调用系统的API接口方法（静态方法）
 * api('User/getName','id=5'); 调用公共模块的User接口的getName方法
 * api('Admin/User/getName','id=5');  调用Admin模块的User接口
 * @param  string  $name 格式 [模块名]/接口名/方法名
 * @param  array|string  $vars 参数
 */
function api($name,$vars=array()){
    $array     = explode('/',$name);
    $method    = array_pop($array);
    $classname = array_pop($array);
    $module    = $array? array_pop($array) : 'Common';
    $callback  = $module.'\\Api\\'.$classname.'Api::'.$method;
    if(is_string($vars)) {
        parse_str($vars,$vars);
    }
    return call_user_func_array($callback,$vars);
}
    </pre>
</div>

<div class="function">
    <a name="time_format" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 时间戳格式化
 * @param int $time
 * @return string 完整的时间显示
 * @author huajie <banhuajie@163.com>
 */
function time_format($time = NULL,$format='Y-m-d H:i:s'){
	if(preg_match('/\d{1,4}[^\d]+\d{1,2}[^\d]+\d{1,2}(\s+\d{1,2}[^\d]+\d{1,2}[^\d]+\d{1,2})?/',$time)){
			return $time;
		}else{
			$time = $time === NULL ? NOW_TIME : intval($time);
			return date($format, $time);			
			}
}

function time_format2($time = NULL,$format='Y-m-d H:i:s'){
	if($time === NULL){
		return '';
		}else{
		 return date($format,intval($time));	
			}
   
}

    </pre>
</div>

<div class="function">
    <a name="delimage" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *删除系统上传的图片
 */
function delimage($id=null){
		if(empty($id))return false;
		//die(file_exists('/oiuou'));
		//图片id号删除
		if(preg_match('/\d+/',$id)){
			//删除本地文件
			$map['id']=$id;
			//if(!IS_ADMIN)$map['uid']=UID;	
			$row=M('Picture')->find($id);

			if(!empty($row)){
				//查找是不是有多个记录共用一个图片
				$row2=M('Picture')->where("sha1='{$row['sha1']}'")->select();
				if(count($row2)<2){
					if(realpath('.'.$row['path']))unlink(realpath('.'.$row['path']));
					if(realpath('.'.$row['thumbpath']))unlink(realpath('.'.$row['thumbpath']));
				}
				$result=M('Picture')->delete($id);
				
				if(0<$result){
					return true;
					}else{
					return false;	
						}
			}else{
				return false;
				}
		//正则字符串中的图片路径
		}else if(file_exists('.'.$id)){
			preg_match_all('/<img.*?src=[\'|\"]{1}(.*?)[\'|\"]{1}.*?>/',$id,$out, PREG_PATTERN_ORDER);
			foreach($out[1] as $val){
				$result=M('Picture')->where("uid=".UID."  and (path='$val' or thumbpath='$val')  ")->delete();
				if(file_exists('.'.$val))unlink('.'.$val);
				//删除缩略图
				$thumbpath=str_replace('image','image/thumb','.'.$val);
				if(file_exists($thumbpath))unlink($thumbpath);
				}
			return true;

		//判断是不是文件路径
		
		}else{		
			//删除数据库中的图片记录
			$result=M('Picture')->where("uid=".UID."  and (path='$id' or thumbpath='$id')  ")->delete();
			if(0<$result){unlink($id);}	
			return true;
			}
//		}else{
//			return false;
//			}
	}
    </pre>
</div>

<div class="function">
    <a name="sendMail" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/*
*功能：发送邮件
*@param:$to     要发送的目标邮箱
*@param:$$subject          邮件的主题
*@param:$body              邮件的主体内容
*@param:FromName           发送人的用户名(昵称)
*@param:toname             接收人的用户名(昵称)
*@param:extra_msg          附加信息(可为空)
*/  

function sendMail($conf=array()){ 
	//ini_set("memory_limit","100M");
	$to=isset($conf['to'])?$conf['to']:'';
	$subject=isset($conf['subject'])?$conf['subject']:'';
	$body=isset($conf['body'])?$conf['body']:'';
	$fromname=isset($conf['fromname'])?$conf['fromname']:'';
	$toname=isset($conf['toname'])?$conf['toname']:'';
	$extra_msg =isset($conf['extra_msg'])?$conf['extra_msg']:'';
	$host =isset($conf['host'])?$conf['host']:'';
	$port =isset($conf['port'])?$conf['port']:'';
	$uname =isset($conf['username'])?$conf['username']:'';
	$pwd =isset($conf['password'])?$conf['password']:'';
	$attachment=isset($conf['attachment'])?$conf['attachment']:'';
	$fromemail=isset($conf['fromemail'])?$conf['fromemail']:'service@ainiku.com'; //来源邮箱

	$host=empty($host)?C('MAIL_SMTP_HOST'):$host;
	$port=empty($port)?C('MAIL_SMTP_PORT'):$port;
	$uname=empty($uname)?C('MAIL_SMTP_USER'):$uname;
	$pwd=empty($pwd)?C('MAIL_SMTP_PASS'):$pwd;
	
	$fromname=empty($fromname)?$uname:$fromname;
	$body=empty($body)?C('MAIL_SMTP_CE'):$body;
	
	
	if(empty($uname))return '收件人邮箱不能为空';
	if(empty($host))return '主机址不能为空';
	if(empty($body))return '邮件内容不能为空';
	if(empty($pwd))return '密码不能为空';
	
	import('Ainiku.PHPMailer');
	$mail = new PHPMailer;
	

	$mail->SMTPDebug  = 0;// 关闭SMTP调试功能
	$mail->IsSMTP();                                  // send via SMTP
    $mail->Host = $host;                 // SMTP servers   
    $mail->SMTPAuth = true;                     // turn on SMTP
	$mail->Username = $uname;      // SMTP username  
    $mail->Password = $pwd;                   // SMTP password   
    $mail->From = $fromemail;           // 发件人邮箱   
    $mail->FromName =$fromname;                   // 发件人   
    $mail->CharSet = "utf-8";        // 这里指定字符集！   
    $mail->Encoding = "base64";   
    $mail->AddAddress($to,$toname);         // 收件人邮箱和姓名
    $mail->IsHTML(true);                     // send as HTML
	//$mail->SMTPSecure = 'ssl';   // 使用安全协议用qq邮箱时要用
    $mail->Subject = $subject;                        // 邮件主题  
    $mail->Body =$body; 
	$mail->WordWrap = 50;              // set word wrap 换行字数                                                              
    $mail->AltBody ="text/html";      
    $mail->AddReplyTo($fromemail,$fromname);  //快捷回复 
	if(!empty($attachment)){
		$mail->AddAttachment($attachment);
		}  
  //$mail->AddAttachment("sendmail.rar");     // attachment 附件   
  //$mail->AddAttachment("psd.jpg", "psd.jpg");  //添加一个附件并且重命名
     
 
  if(!$mail->Send()){   
        return $mail->ErrorInfo;
  }else{
      return true;
	   }
}
    </pre>
</div>

<div class="function">
    <a name="delfile" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *删除系统上传的附件/文件
 **/
function delfile($id=null){
		if(empty($id))return false;
		//删除本地文件
		$row=M('File')->find($id);
		if(!empty($row)){
		$path=realpath('.'.$row['path']);
		if($path)unlink($path);
		$result=M('File')->delete($id);
		if(0<$result){
			return true;
			}else{
			return false;	
				}
		}else{
			return false;
			}
	}
    </pre>
</div>

<div class="function">
    <a name="createorder" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *生成不重复的订单号
 */
function createorder(){
		return substr(date("YmdHis").mt_rand(1000,9999),2);
	}
    </pre>
</div>

<div class="function">
    <a name="msubstr" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 字符串截取，支持中文和其他编码
 * @static
 * @access public
 * @param string $str 需要转换的字符串
 * @param string $start 开始位置
 * @param string $length 截取长度
 * @param string $charset 编码格式
 * @param string $suffix 截断显示字符
 * @return string
 */
function msubstr($str, $start=0, $length, $charset="utf-8", $suffix=true) {
    if(function_exists("mb_substr"))
        $slice = mb_substr($str, $start, $length, $charset);
    elseif(function_exists('iconv_substr')) {
        $slice = iconv_substr($str,$start,$length,$charset);
        if(false === $slice) {
            $slice = '';
        }
    }else{
        $re['utf-8']   = "/[\x01-\x7f]|[\xc2-\xdf][\x80-\xbf]|[\xe0-\xef][\x80-\xbf]{2}|[\xf0-\xff][\x80-\xbf]{3}/";
        $re['gb2312'] = "/[\x01-\x7f]|[\xb0-\xf7][\xa0-\xfe]/";
        $re['gbk']    = "/[\x01-\x7f]|[\x81-\xfe][\x40-\xfe]/";
        $re['big5']   = "/[\x01-\x7f]|[\x81-\xfe]([\x40-\x7e]|\xa1-\xfe])/";
        preg_match_all($re[$charset], $str, $match);
        $slice = join("",array_slice($match[0], $start, $length));
    }
    return $suffix ? $slice.'...' : $slice;
}
    </pre>
</div>

<div class="function">
    <a name="mbstringtoarray" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *把字符串转成数组
 *@param $str 字符串
 *@param $charset 字符串编码
 */
function mbstringtoarray($str,$charset) {
    $strlen=mb_strlen($str);
    while($strlen){
        $array[]=mb_substr($str,0,1,$charset);
        $str=mb_substr($str,1,$strlen,$charset);
        $strlen=mb_strlen($str);
    }
    return $array;
}

    </pre>
</div>

<div class="function">
    <a name="removeHtml" class="mark"></a>
    <pre class="brush:js;toolbar:false">
function removeHtml($str, $start=0, $length, $charset="utf-8", $suffix=true){
	//$str=strip_tags($str);
	$str=preg_replace(array('/<.*?>/i','/[\s|\t|\n|\r]+/i'),'',$str);
	return msubstr($str, $start=0, $length, $charset="utf-8", $suffix=true);
}
    </pre>
</div>

<div class="function">
    <a name="filter_html" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *过滤html标签
 *@param string
 */
 function filter_html($str){
	 $panner='/((&lt;)|<)(.*?)(>|(&gt;))/si';
	 $str=preg_replace($panner,'',$str);
	 return $str;
	 }
    </pre>
</div>

<div class="function">
    <a name="gbkjson_encode" class="mark"></a>
    <pre class="brush:js;toolbar:false">
    /**
     *支持中文json编码
     */
    function gbkjson_encode($str) {  
        return urldecode(json_encode(url_encode($str)));      
    }  
function url_encode($str) {  
    if(is_array($str)) {  
        foreach($str as $key=>$value) {  
            $str[urlencode($key)] = url_encode($value);  
        }  
    } else {  
        $str = urlencode($str);  
    }  
      
    return $str;  
}  
    </pre>
</div>

<div class="function">
    <a name="check_dir_iswritable" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *检查目录是否可写
 */
function check_dir_iswritable($dir_path){ 
$dir_path=str_replace('\\','/',$dir_path); 
$is_writale=1; 
if(!is_dir($dir_path)){ 
	$is_writale=0; 
	return $is_writale; 
}else{ 
	$file_hd=fopen($dir_path.'/test.txt','w'); 
	if(!$file_hd){ 
	$is_writale=0; 
	return $is_writale; 
	}else{
	fclose($file_hd); 
	unlink($dir_path.'/test.txt');		
		}
  

	$dir_hd=opendir($dir_path); 
	while(false!==($file=readdir($dir_hd))){ 
	if ($file != "." && $file != "..") { 
	if(is_file($dir_path.'/'.$file)){ 
	//文件不可写，直接返回 
	if(!is_writable($dir_path.'/'.$file)){ 
	return 0; 
	} 
}else{ 
	$file_hd2=fopen($dir_path.'/'.$file.'/test.txt','w'); 
	if(!$file_hd2){ 

		$is_writale=0; 
		return $is_writale; 
	}else{
		fclose($file_hd2); 
		unlink($dir_path.'/'.$file.'/test.txt');		
		}
  
	//递归 
	$is_writale=check_dir_iswritable($dir_path.'/'.$file); 
} 
} 
} 
} 
return $is_writale; 
} 
    </pre>
</div>

<div class="function">
    <a name="createAccount" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *生成账号
 **/
function createAccount(){
	while(true){
		$num=rand(10000000,99999999);
		$map['account']=$num;
		$info=M('Member')->where($map)->select();
		if(empty($info)){
			return $num;
			}
		}
	}
    </pre>
</div>

<div class="function">
    <a name="getAccountType" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *判断账号是什么类型
 **/
 function getAccountType($str){
	 if(preg_match('/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/i',$str)){return 'email';}
	 if(preg_match('/^1[34578]\d{9}$/',$str)){return 'mobile';}
	 
	 return 'username';
	 
	 }
    </pre>
</div>

<div class="function">
    <a name="Pinyin" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *汉字转拼音
 **/
 function Pinyin($_String, $_Code='UTF8'){ //GBK页面可改为gb2312，其他随意填写为UTF8
        $_DataKey = "a|ai|an|ang|ao|ba|bai|ban|bang|bao|bei|ben|beng|bi|bian|biao|bie|bin|bing|bo|bu|ca|cai|can|cang|cao|ce|ceng|cha".        "|chai|chan|chang|chao|che|chen|cheng|chi|chong|chou|chu|chuai|chuan|chuang|chui|chun|chuo|ci|cong|cou|cu|". 
                        "cuan|cui|cun|cuo|da|dai|dan|dang|dao|de|deng|di|dian|diao|die|ding|diu|dong|dou|du|duan|dui|dun|duo|e|en|er". 
                        "|fa|fan|fang|fei|fen|feng|fo|fou|fu|ga|gai|gan|gang|gao|ge|gei|gen|geng|gong|gou|gu|gua|guai|guan|guang|gui". 
                        "|gun|guo|ha|hai|han|hang|hao|he|hei|hen|heng|hong|hou|hu|hua|huai|huan|huang|hui|hun|huo|ji|jia|jian|jiang". 
                        "|jiao|jie|jin|jing|jiong|jiu|ju|juan|jue|jun|ka|kai|kan|kang|kao|ke|ken|keng|kong|kou|ku|kua|kuai|kuan|kuang". 
                        "|kui|kun|kuo|la|lai|lan|lang|lao|le|lei|leng|li|lia|lian|liang|liao|lie|lin|ling|liu|long|lou|lu|lv|luan|lue". 
                        "|lun|luo|ma|mai|man|mang|mao|me|mei|men|meng|mi|mian|miao|mie|min|ming|miu|mo|mou|mu|na|nai|nan|nang|nao|ne". 
                        "|nei|nen|neng|ni|nian|niang|niao|nie|nin|ning|niu|nong|nu|nv|nuan|nue|nuo|o|ou|pa|pai|pan|pang|pao|pei|pen". 
                        "|peng|pi|pian|piao|pie|pin|ping|po|pu|qi|qia|qian|qiang|qiao|qie|qin|qing|qiong|qiu|qu|quan|que|qun|ran|rang". 
                        "|rao|re|ren|reng|ri|rong|rou|ru|ruan|rui|run|ruo|sa|sai|san|sang|sao|se|sen|seng|sha|shai|shan|shang|shao|". 
                        "she|shen|sheng|shi|shou|shu|shua|shuai|shuan|shuang|shui|shun|shuo|si|song|sou|su|suan|sui|sun|suo|ta|tai|". 
                        "tan|tang|tao|te|teng|ti|tian|tiao|tie|ting|tong|tou|tu|tuan|tui|tun|tuo|wa|wai|wan|wang|wei|wen|weng|wo|wu". 
                        "|xi|xia|xian|xiang|xiao|xie|xin|xing|xiong|xiu|xu|xuan|xue|xun|ya|yan|yang|yao|ye|yi|yin|ying|yo|yong|you". 
                        "|yu|yuan|yue|yun|za|zai|zan|zang|zao|ze|zei|zen|zeng|zha|zhai|zhan|zhang|zhao|zhe|zhen|zheng|zhi|zhong|". 
                        "zhou|zhu|zhua|zhuai|zhuan|zhuang|zhui|zhun|zhuo|zi|zong|zou|zu|zuan|zui|zun|zuo"; 
        $_DataValue = "-20319|-20317|-20304|-20295|-20292|-20283|-20265|-20257|-20242|-20230|-20051|-20036|-20032|-20026|-20002|-19990". 
                        "|-19986|-19982|-19976|-19805|-19784|-19775|-19774|-19763|-19756|-19751|-19746|-19741|-19739|-19728|-19725". 
                        "|-19715|-19540|-19531|-19525|-19515|-19500|-19484|-19479|-19467|-19289|-19288|-19281|-19275|-19270|-19263". 
                        "|-19261|-19249|-19243|-19242|-19238|-19235|-19227|-19224|-19218|-19212|-19038|-19023|-19018|-19006|-19003". 
                        "|-18996|-18977|-18961|-18952|-18783|-18774|-18773|-18763|-18756|-18741|-18735|-18731|-18722|-18710|-18697". 
                        "|-18696|-18526|-18518|-18501|-18490|-18478|-18463|-18448|-18447|-18446|-18239|-18237|-18231|-18220|-18211". 
                        "|-18201|-18184|-18183|-18181|-18012|-17997|-17988|-17970|-17964|-17961|-17950|-17947|-17931|-17928|-17922". 
                        "|-17759|-17752|-17733|-17730|-17721|-17703|-17701|-17697|-17692|-17683|-17676|-17496|-17487|-17482|-17468". 
                        "|-17454|-17433|-17427|-17417|-17202|-17185|-16983|-16970|-16942|-16915|-16733|-16708|-16706|-16689|-16664". 
                        "|-16657|-16647|-16474|-16470|-16465|-16459|-16452|-16448|-16433|-16429|-16427|-16423|-16419|-16412|-16407". 
                        "|-16403|-16401|-16393|-16220|-16216|-16212|-16205|-16202|-16187|-16180|-16171|-16169|-16158|-16155|-15959". 
                        "|-15958|-15944|-15933|-15920|-15915|-15903|-15889|-15878|-15707|-15701|-15681|-15667|-15661|-15659|-15652". 
                        "|-15640|-15631|-15625|-15454|-15448|-15436|-15435|-15419|-15416|-15408|-15394|-15385|-15377|-15375|-15369". 
                        "|-15363|-15362|-15183|-15180|-15165|-15158|-15153|-15150|-15149|-15144|-15143|-15141|-15140|-15139|-15128". 
                        "|-15121|-15119|-15117|-15110|-15109|-14941|-14937|-14933|-14930|-14929|-14928|-14926|-14922|-14921|-14914". 
                        "|-14908|-14902|-14894|-14889|-14882|-14873|-14871|-14857|-14678|-14674|-14670|-14668|-14663|-14654|-14645". 
                        "|-14630|-14594|-14429|-14407|-14399|-14384|-14379|-14368|-14355|-14353|-14345|-14170|-14159|-14151|-14149". 
                        "|-14145|-14140|-14137|-14135|-14125|-14123|-14122|-14112|-14109|-14099|-14097|-14094|-14092|-14090|-14087". 
                        "|-14083|-13917|-13914|-13910|-13907|-13906|-13905|-13896|-13894|-13878|-13870|-13859|-13847|-13831|-13658". 
                        "|-13611|-13601|-13406|-13404|-13400|-13398|-13395|-13391|-13387|-13383|-13367|-13359|-13356|-13343|-13340". 
                        "|-13329|-13326|-13318|-13147|-13138|-13120|-13107|-13096|-13095|-13091|-13076|-13068|-13063|-13060|-12888". 
                        "|-12875|-12871|-12860|-12858|-12852|-12849|-12838|-12831|-12829|-12812|-12802|-12607|-12597|-12594|-12585". 
                        "|-12556|-12359|-12346|-12320|-12300|-12120|-12099|-12089|-12074|-12067|-12058|-12039|-11867|-11861|-11847". 
                        "|-11831|-11798|-11781|-11604|-11589|-11536|-11358|-11340|-11339|-11324|-11303|-11097|-11077|-11067|-11055". 
                        "|-11052|-11045|-11041|-11038|-11024|-11020|-11019|-11018|-11014|-10838|-10832|-10815|-10800|-10790|-10780". 
                        "|-10764|-10587|-10544|-10533|-10519|-10331|-10329|-10328|-10322|-10315|-10309|-10307|-10296|-10281|-10274". 
                        "|-10270|-10262|-10260|-10256|-10254"; 
        $_TDataKey   = explode('|', $_DataKey); 
        $_TDataValue = explode('|', $_DataValue);
        $_Data = array_combine($_TDataKey, $_TDataValue);
        arsort($_Data); 
        reset($_Data);
        if($_Code!= 'gb2312') $_String = _U2_Utf8_Gb($_String); 
        $_Res = ''; 
        for($i=0; $i<strlen($_String); $i++) { 
                $_P = ord(substr($_String, $i, 1)); 
                if($_P>160) { 
                        $_Q = ord(substr($_String, ++$i, 1)); $_P = $_P*256 + $_Q - 65536;
                } 
                $_Res .= _Pinyin($_P, $_Data); 
        } 
        return preg_replace("/[^a-z0-9]*/", '', $_Res); 
} 
function _Pinyin($_Num, $_Data){ 
        if($_Num>0 && $_Num<160 ){
                return chr($_Num);
        }elseif($_Num<-20319 || $_Num>-10247){
                return '';
        }else{ 
                foreach($_Data as $k=>$v){ if($v<=$_Num) break; } 
                return $k; 
        } 
}
function _U2_Utf8_Gb($_C){ 
        $_String = ''; 
        if($_C < 0x80){
                $_String .= $_C;
        }elseif($_C < 0x800) { 
                $_String .= chr(0xC0 | $_C>>6); 
                $_String .= chr(0x80 | $_C & 0x3F); 
        }elseif($_C < 0x10000){ 
                $_String .= chr(0xE0 | $_C>>12); 
                $_String .= chr(0x80 | $_C>>6 & 0x3F); 
                $_String .= chr(0x80 | $_C & 0x3F); 
        }elseif($_C < 0x200000) { 
                $_String .= chr(0xF0 | $_C>>18); 
                $_String .= chr(0x80 | $_C>>12 & 0x3F); 
                $_String .= chr(0x80 | $_C>>6 & 0x3F); 
                $_String .= chr(0x80 | $_C & 0x3F); 
        } 
        return iconv('UTF-8', 'GB2312', $_String); 
}

    </pre>
</div>

<div class="function">
    <a name="rm_empty_dir" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/** 删除所有空目录 
* @param String $path 目录路径 
*/  
function rm_empty_dir($path){  
    if(is_dir($path) && ($handle = opendir($path))!==false){  
        while(($file=readdir($handle))!==false){     // 遍历文件夹  
            if($file!='.' && $file!='..'){  
                $curfile = $path.'/'.$file;          // 当前目录  
                if(is_dir($curfile)){                // 目录  
                    rm_empty_dir($curfile);          // 如果是目录则继续遍历  
                    if(count(scandir($curfile))==2){ // 目录为空,=2是因为. 和 ..存在  
                        rmdir($curfile);             // 删除空目录  
                    }  
                }  
            }  
        }  
        closedir($handle);  
    }  
} 
    </pre>
</div>

<div class="function">
    <a name="toUtf8" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *把字符串转成utf
 *
 **/
 function toUtf8($str=null){
		if(is_utf8($str)){
			return $str;
		}else{
			return iconv('gbk', 'utf-8', $str);
		}	
}
/**
 *把字符串转成utf8如果本身就是utf8的话原样返回
 *
 **/
function is_utf8($str){
$len = strlen($str);
for($i = 0; $i < $len; $i++){
	$c = ord($str[$i]);
	if ($c > 128) {
	if (($c > 247)) return false;
	elseif ($c > 239) $bytes = 4;
	elseif ($c > 223) $bytes = 3;
	elseif ($c > 191) $bytes = 2;
	else return false;
	if (($i + $bytes) > $len) return false;
	while ($bytes > 1) {
	$i++;
	$b = ord($str[$i]);
	if ($b < 128 || $b > 191) return false;
	$bytes--;
	}
	}
}
return true;
}	

    </pre>
</div>

<div class="function">
    <a name="compress_css" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *压缩css
 **/
function compress_css($path){
 $dirname=dirname($path);//当前css文件的路径目录
$ipath=$path;
$str='';
if($ipath){
$str=file_get_contents($ipath);
//把文件压缩
$arr=array('/(\n|\t|\s)*/i','/\n|\t|\s(\{|}|\,|\:|\;)/i','/(\{|}|\,|\:|\;)\s/i');
$str=preg_replace($arr,'$1',$str);
$str=preg_replace('/(\/\*.*?\*\/\n?)/i','',$str);

//查找出样式文件中的图片
preg_match_all("/url\(\s*?[\'|\"]?(.*?)[\'|\"]?\)/",$str,$out);
	foreach($out[1] as $v){
		if(strpos($v,'../images')!==false){
		$src_new=str_replace("../images",$dirname."/images",$v);//源绝对路径
		$src_new=str_replace('css/','',$src_new);
		$new=str_replace("../images",STYLE_CACHE_DIR.MODULE_NAME."/images",$v);//设置新路径
		$new=__SITE_ROOT__.__ROOT__.str_replace('./','/',$new);
		createFolder(dirname($new));
		if(file_exists($src_new)){//判断是否存在
		copy($src_new,$new);//复制到新目录
		}
		}
	}
 $str=str_replace('../images','./images',$str);
}else{
die("path is not found:".$ipath);
}
 return $str;
}
    </pre>
</div>

<div class="function">
    <a name="compress_js" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *压缩JS文件并替换JS嵌套include文件
 */
function compress_js($jspath){
//	import('Ainiku.JavaScriptPacker');
//    $packer = new JavaScriptPacker($js, 'Normal', true, false);  
//    return $packer->pack();
	$js=file_get_contents($jspath);
	import('Ainiku.JSMin');
	return JSMin::minify($js);
}
    </pre>
</div>

<div class="function">
    <a name="writetofile" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *写字符串到文件
 */
function writetofile($filename,$str){
	if(createFolder(dirname($filename))){
		return file_put_contents($filename,$str);
	}else{
	//\Think\Log::write("mkdir err: ".$dirname($fpath));
	die($dirname($fpath));	
	}
	
	}
    </pre>
</div>

<div class="function">
    <a name="createFolder" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *创建文件夹
 */
function createFolder($path){
	$path=pathA($path);
	if(!is_dir($path)){
	return mkdir($path,0777,true);//第三个参数为true即可以创建多极目录
	}else{
	return true;	
		}
}
    </pre>
</div>

<div class="function">
    <a name="get_naps_bot" class="mark"></a>
    <pre class="brush:js;toolbar:false">
	/**
	 *判断是不是蜘蛛访问
	 */
	function get_naps_bot(){
		$spider='googlebot,360spider,haosouspider,baiduspider,msnbot,slurp,sosospider,sogou spider,yodaobot';
		 $restr=false;
			$useragent = strtolower($_SERVER['HTTP_USER_AGENT']);
		if (strpos($useragent, 'googlebot') !== false){
			$restr='google';
			}
		if (strpos($useragent, '360Spider') !== false || strpos($useragent, 'haosouspider') !== false ){
			$restr='360';
			}
			if (strpos($useragent, 'baiduspider') !== false){
			$restr='baidu';
			}
			if (strpos($useragent, 'msnbot') !== false){
			$restr='bing';
			}
			if (strpos($useragent, 'slurp') !== false){
			$restr= 'yahoo';
			}
			if (strpos($useragent, 'sosospider') !== false){
			$restr='soso';
			}
			if (strpos($useragent, 'sogou spider') !== false){
			$restr='sogou';
			}
			if (strpos($useragent, 'yodaobot') !== false){
			$restr='yodao';
			}
				return $restr;
			
	}	
    </pre>
</div>

<div class="function">
    <a name="pathA" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *把路径格式化为本地文件的绝对路径
 */
 function pathA($path){
	 $path=str_replace(array('\\','./',__SITE_ROOT__.__ROOT__,__SITE_ROOT__,__ROOT__),array('/','/','','',''),$path);
	 return __SITE_ROOT__.__ROOT__.$path;
	 }

    </pre>
</div>

<div class="function">
    <a name="pathR" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *把路径格式化为相对于网站根目录的路径
 */
 function pathR($path){
	 $path=str_replace(array('\\','./',__SITE_ROOT__.__ROOT__,__SITE_ROOT__,__ROOT__),array('/','/','','',''),$path);
	 return __ROOT__.$path;
	 }

    </pre>
</div>

<div class="function">
    <a name="file_ismod" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *判断文件是否已经被修改
 */
function file_ismod($filepath){
	$filearr=array();
	if(is_array($filepath)){
		$filearr=$filepath;
	}else{
		$filearr[]=$filepath;
		}
	foreach($filearr as $val){
		$sval=pathA($val);
		$modtime=date('Y-m-d h:i:s',filemtime($sval));
		if($modtime){
		$path=str_replace(array('/','\\'),array('_'),$val);
		$modstime=F('_modfile/'.$path);
		if($modtime!==$modstime){
			F('_modfile/'.$path,$modtime);
			return true;
			}
		}	
		}
		return false;

	}
    </pre>
</div>


<div class="function">
    <a name="getDirList" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 返回一个目录中的目录列表(只返回一级)
 * @param string $path
 */
function getDirList($dir){
	$dirArray[]=NULL;
	if (false != ($handle = opendir ( $dir ))) {
		$i=0;
		while ( false !== ($file = readdir ( $handle )) ) {
			//去掉"“.”、“..”以及带“.xxx”后缀的文件
			if ($file != "." && $file != ".."&&!strpos($file,".")) {
				$dirArray[$i]=$file;
				$i++;
			}
		}
		//关闭句柄
		closedir ( $handle );
	}
	return $dirArray;
}
    </pre>
</div>

<div class="function">
    <a name="hook" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 系统钩子函数
 * @param $name 钩子名字
 */
function hook($name,$param=array())
{
  $map['status']=1;
  $map['mark']=$name;
  $map['status']=1;
  $rows=M('Hooks')->field('id,pluginid')->where($map)->find();
  if(!empty($rows)){
  	$pluginidarr=explode(',', $rows['pluginid']);
  }else{
    //钩子不存在
    //throw new \Exception("钩子$name不存在");
  	trace("钩子'{$name}'不存在或被禁用");
    return null;
  }
  //运行钩子上的插件列表
  $str='';
  if(!empty($pluginidarr)){
  foreach ($pluginidarr as $a){
    if(empty($a))continue;
    $model=M('addons')->where("id=$a")->find();
    if(!empty($model) && $model['status']==='1'){
    	$method=isset($param['method'])?$param['method']:'run';
    	$str.=runPluginMethod($model['mark'],$method,$param);
    }elseif($model['status']===0){  	
    	trace("插件:[名字]{$model['name']},[标识]{$model['mark']} 被禁用");
    }elseif(!empty($model['id'])){
      removePluginFromHook($rows['id'], $a);
      trace("插件id: $a 对应的插件不存在,已从钩子列表中移除");     
    }
  }
  }
  return $str;
}
    </pre>
</div>

<div class="function">
    <a name="UP" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/*
 * 生成插件url地址
 * @param string $name Test/set 插件和操作
 * @param string $param 数组参数
 * */
function UP($name=null,$param=array()){
    $a=array();
	$ab=strpos($name,'?');
	if($ab!==false){
		$a=explode('/', substr($name,0,$ab));
		}else{
		$a=explode('/', $name);	
			}
    $data=array(
    	'pn'=>$a[0],
        'pm'=>$a[1]
    );
	$data=array_merge($data,$param);
	//查找参数字符串
	preg_match('/\w+\/\w+\?(.*)/',$name,$out);
	if(!empty($out[1]))
    $data=array_merge($data,parseParam($out[1]));
	//C('URL_MODEL',0);
	return U('Addons/plugin',$data);
}
    </pre>
</div>

<div class="function">
    <a name="parseParam" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *参数转成数组
 */
 function parseParam($str){
	 $arr=explode('&',$str);
	 $rearr=array();
	 foreach($arr as $val){
		 $ar=explode('=',$val);
		 $rearr[trim($ar[0])]=trim($ar[1]);
		 }
		return $rearr;
	 }
    </pre>
</div>

<div class="function">
    <a name="runPluginMethod" class="mark"></a>
    <pre class="brush:js;toolbar:false">
  /*
   * 调用插件方法
   * @param string $name 插件名字
   * @param string $method 插件调用的方法
   * @param string $param一维数组传参数,返数组顺序传参
   * 返回方法的返回值
   */
function runPluginMethod($pn=null,$pm=null,$param=array()){
    //包含插件目录
    require_once  ADDONS_PATH.$pn.'/'.$pn.'Plugin.class.php';
    $str="\\".ADDONS_DIR_NAME."\\$pn\\".$pn.'Plugin';
    $temobj=new $str();
    return call_user_func_array(array($temobj,$pm),$param);
  }
    </pre>
</div>

<div class="function">
    <a name="plugin" class="mark"></a>
    <pre class="brush:js;toolbar:false">
 function plugin($name,$param=array()){
	 try{
		//包含插件目录
		$narr=explode('/',$name);
		require_once  ADDONS_PATH.$narr[0].'/'.$narr[0].'Plugin.class.php';
		$str="\\".ADDONS_DIR_NAME."\\{$narr[0]}\\".$narr[0].'Plugin';
		$temobj=new $str();
		return call_user_func_array(array($temobj,$narr[1]),array($param));	 
	 }catch(Exception $e){
		 throw new \Think\Exception($e->getMessage());
		 }
	 }
    </pre>
</div>

<div class="function">
    <a name="removePluginFromHook" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/*
 * 从钩子中移除一个插件
 * @param string $hid 钩子id
 * @param string $aid 插件id,支持多个用,分隔
 * 成功返回true，失败返回false
 * */
function removePluginFromHook($hid,$aid){
    $model=M('Hooks')->where("id=$hid")->field('pluginid')->find();
    $temarr=explode(',',$model['pluginid']);
    $result=array();
    foreach ($temarr as $a){
    		$str=stripos($aid,$a);
    		if($str===false){
    		  $result[]=$a;
    		}
    }
    $str=implode(',', $result);
    $res=M('Hooks')->where("id=$hid")->save(array('pluginid'=>$str));
    if($res){
    	return  true;
    }else{
    	return false;
    }
}
    </pre>
</div>

<div class="function">
    <a name="addPluginToHook" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/*
 * 向钩子中添加一个插件
* @param string $hid 钩子id
* @param string $aid 插件id,支持多个用,分隔
* 成功返回true，失败返回false
* */
function addPluginToHook($hid,$aid){
  $model=M('Hooks')->where("id=$hid")->field('pluginid')->find();
  $str1=$model['pluginid'];
  $str='';
  if(empty($str1)){
  	$str=$aid;
  }else{
  	$str=$str1.','.$aid;
  }
  $res=M('Hooks')->where("id=$hid")->save(array('pluginid'=>$str));
  if($res){
    return  true;
  }else{
    return false;
  }
}
    </pre>
</div>

<div class="function">
    <a name="DP" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *实例化扩展模型
 *@param $pname 扩展名字
 *@param $model 模型名字
 */
 function DP($model,$pname){
	  if(empty($model)) return new Think\Model;
	  $model='\Plugins\\'.$pname.'\\Model\\'.$model.'Model';
	  return new $model();
	 }
    </pre>
</div>

<div class="function">
    <a name="markimg" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 *给目标图片添加水印
//使用示例
markimg(array(
	'dst'=>'./images/1.jpg',//原始图像
	'src'=>'./images/ico.png',//水印图像
	'pos'=>'center'//水印位置('left,right,center'),
	'str'=>'水印文字'
));
 */
function markimg($info=array(
					'det'=>null,
					'src'=>null,
					'pos'=>'right',
					'str'=>''
					)){
		//原始图像 
       $dst =$info['dst'] ;//"./images/tu.png"; //注意图片路径要正确 
	   //水印图像 
       $src = $info['src'];//"./images/ico.png"; //注意路径要写对
		//水印在原图的位置比例
		$pos=$info['pos'];
       //得到原始图片信息 
       $dst_info = getimagesize($dst);
	   //检查图片大小符合添加水印的条件不
	   $tj=explode('X',C('SHUIYIN_TIAOJIAN'));  
       if(!($dst_info[0]>=intval($tj[0]) && $dst_info[1]>=intval($tj[1])))return false;
	   switch ($dst_info[2]) 
       { 
        case 1: $dst_im =imagecreatefromgif($dst);break;
        case 2: $dst_im =imagecreatefromjpeg($dst);break;
        case 3: $dst_im =imagecreatefrompng($dst);break; 
        case 6: $dst_im =imagecreatefromwbmp($dst);break; 
        default: return("不支持的文件类型1"); 
       } 
	
	 if($info['str']!=''){
		  $font_size = 14;
		  $fontname = 'C:\WINDOWS\Fonts\simkai.ttf';
		  $black = imagecolorallocate($dst_im,0,0,0);
		  $arr=imagettfbbox($font_size,0,$fontname,$info['str']);
		  $hh=abs($arr[7]-$arr[1]);
		  $ww=abs($arr[2]-$arr[0]);
	   switch($pos){
		   case 'right':
		   //右下角
			 imagettftext($dst_im ,$font_size,0,$dst_info[0]-$ww-10,$dst_info[1]-$hh+10,$black,$fontname,$info['str']);
		   break;
		   case 'center':
		   //正中间
			 imagettftext($dst_im ,$font_size,0,($dst_info[0]-$ww-10)/2,$dst_info[1]-$hh+10,$black,$fontname,$info['str']);
			break; 
		   default :
		   //左下角
		    imagettftext($dst_im ,$font_size,0,10,$dst_info[1]-$hh+10,$black,$fontname,$info['str']);
		   }
		 
	}else{
		 //添加图片水印
       $src_info = getimagesize($src); 
       switch ($src_info[2]) 
       { 
        case 1: $src_im =imagecreatefromgif($src);break;    
        case 2: $src_im =imagecreatefromjpeg($src);break;   
        case 3: $src_im =imagecreatefrompng($src);break;
        case 6: $src_im =imagecreatefromwbmp($src);break; 
        default: return("不支持的文件类型1"); 
       } 
       //支持png本身透明度的方式
	   switch($pos){
		   case 'right':
		   //右下角
	  	   imagecopy($dst_im,$src_im,$dst_info[0]-$src_info[0]-10,$dst_info[1]-$src_info[1]-10,0,0,$src_info[0],$src_info[1]);
		   break;
		   case 'center':
		   //正中间
			imagecopy($dst_im,$src_im,($dst_info[0]-$src_info[0])/2,($dst_info[1]-$src_info[1])/2,0,0,$src_info[0],$src_info[1]);
			break; 
		   default :
		   //左下角
			imagecopy($dst_im,$src_im,10,$dst_info[1]-$src_info[1]-10,0,0,$src_info[0],$src_info[1]);
		   }
	}
	   //保存图片 
       switch ($dst_info[2]){ 
        case 1: imagegif($dst_im,$dst);break;
        case 2: imagejpeg($dst_im,$dst);break; 
        case 3: imagepng($dst_im,$dst);break;    
        case 6: imagewbmp($dst_im,$dst);break; 
        default: 
        return("不支持的文件类型2"); 
       } 
       imagedestroy($dst_im); 
       imagedestroy($src_im);   	
	   return true;
	}
    </pre>
</div>

<div class="function">
    <a name="img2thumb" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * 生成缩略图
 * @author yangzhiguo0903@163.com
 * @param string     源图绝对完整地址{带文件名及后缀名}
 * @param string     目标图绝对完整地址{带文件名及后缀名}
 * @param int        缩略图宽{0:此时目标高度不能为0，目标宽度为源图宽*(目标高度/源图高)}
 * @param int        缩略图高{0:此时目标宽度不能为0，目标高度为源图高*(目标宽度/源图宽)}
 * @param bool createimg  true输出到浏览器 false输出到文件
 * @param bool proportion  剪切true  缩放false会有白边框
 * @return boolean
 */
function img2thumb($src_img, $dst_img, $width = 75, $height = 75,$createimg=true,$proportion = false)
{
    if(!is_file($src_img))
    {
        return false;
    }
	$to='';
	if(!empty($dst_img)){
		$ot =strtolower(pathinfo($dst_img, PATHINFO_EXTENSION));
		$dirname =pathinfo($dst_img, PATHINFO_DIRNAME);
		if(!file_exists($dirname))createFolder($dirname);
	}else{
		$ot =strtolower(pathinfo($src_img, PATHINFO_EXTENSION));
		}
    $otfunc = 'image' . ($ot == 'jpg' ? 'jpeg' : $ot);
    $srcinfo = getimagesize($src_img);
    $src_w = $srcinfo[0];
    $src_h = $srcinfo[1];
	//if($src_h<intval(C('THUMB_HEIGHT')) || $src_w<intval(C('THUMB_WIDTH'))){return false;}
    $type  = strtolower(substr(image_type_to_extension($srcinfo[2]), 1));
    $createfun = 'imagecreatefrom' . ($type == 'jpg' ? 'jpeg' : $type);

 	if(!$createimg)header('content-type:image/'.($type == 'jpg' ? 'jpeg' : $type));
    $dst_h = $height;
    $dst_w = $width;
    $x = $y = 0;

	$zfxbili=0.00;
	//如果缩略图是正方形，算出源图的宽高比例如果接近正方形的话就生成正方形的图片
	if($width==$height){
		$zfxbili=doubleval($src_w)/doubleval($src_h);
	}

    //源图和缩略图一样大小的情况直接复制
    if($src_w==$width && $src_h==$height){
    	return copy($src_img,$dst_img);
    }
	$src_image=$createfun($src_img);
	
	$cropped_image = imagecreatetruecolor($width, $height);
	
	if($width==$height && 1.2>$zfxbili && $zfxbili>=0.8){
		$white = imagecolorallocate($cropped_image, 255, 255, 255);
		imagefill($cropped_image, 0, 0, $white);
		}else{
		imagesavealpha($src_image,true);//这里很重要;
		$alpha= imagecolorallocatealpha($cropped_image,255,255,255,127);
		imagealphablending($cropped_image,false);//这里很重要,意思是不合并颜色,直接用$img图像颜色替换,包括透明色;
		imagesavealpha($cropped_image,true);//这里很重要,意思是不要丢了$thumb图像的透明色
		imagefill($cropped_image, 0, 0, $alpha);
		}
//剪切图片(先从源图片中按缩略图的比例剪切出一个区域再缩放到缩略图中)
if($proportion){
	//源图比缩略图大的情况
	if($src_w>$width && $src_h>$height){
		//缩略图宽高一样的情况
		if($width==$height){
	 		//源图类似正方形2:1 比例 宽大于高 
			if($zfxbili>1 && $zfxbili<1.2){
				//算出缩放的实际高度
				$ah=$src_h*$width/$src_w;
				//算出实际的y轴
				$ay=($height-$ah)/2;
				imagecopyresampled($cropped_image, $src_image,0,$ay, 0, 0, $width,$ah, $src_w, $src_h);
				if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
				imagedestroy($cropped_image);
				imagedestroy($src_image);
				return true;
			}
			//源图类似正方形1:2 比例 高大于宽 
			if($zfxbili>=0.8 && $zfxbili<1.2){
				//算出缩放的实际宽度
				$aw=$src_w*$height/$src_h;
				//算出实际的x轴
				$ax=($width-$aw)/2;
				imagecopyresampled($cropped_image, $src_image,$ax,0, 0, 0, $aw, $height, $src_w, $src_h);
				if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
				imagedestroy($cropped_image);
				imagedestroy($src_image);
				return true;
			}
	 		//源图宽高一样
			if($src_h==$src_w){
				imagecopyresampled($cropped_image, $src_image,0,0, 0, 0, $width, $height, $src_w, $src_h);
				if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
				imagedestroy($cropped_image);
				imagedestroy($src_image);
				return true;
			}
			//源图宽大于高
			if($src_w>$src_h){
				$ww=$src_h;
				$_x=($src_w-$src_h)/2; 
				imagecopyresampled($cropped_image, $src_image,0,0, $_x, 0, $width, $height, $ww, $ww);
				if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
				imagedestroy($cropped_image);
				imagedestroy($src_image);
				return true;
			}else{
			//源图宽小于等于高
				$ww=$src_w;
				$_y=($src_h-$src_w)/2;
				imagecopyresampled($cropped_image, $src_image,0,0, 0, $_y, $width, $height, $ww, $ww);
				if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
				imagedestroy($cropped_image);
				imagedestroy($src_image);
				return true;
			}
		}else{//缩略图宽高不一样的情况
				//缩略图宽大于高
				if($width>$height){
				 	$bili=($width/$height);
					$hh=$src_w/$bili;
					$_y=($src_h-$hh)/2;
				 	if($src_w>$src_h){
						//查找合适剪切的高
						$tem_w=$src_w;
						$tem_h=0;
						while(true){
							$tem_h=($tem_w/$bili);
							if($tem_h<=$src_h){break;}else{$tem_w--;}
						}
						$_x=($src_w-$tem_w)/2;
						$_y=($src_h-$tem_h)/2;
						imagecopyresampled($cropped_image, $src_image,0,0, $_x, $_y, $width, $height, $tem_w, $tem_h);
						if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
						imagedestroy($cropped_image);
						imagedestroy($src_image);
						return true;
					}else{
						imagecopyresampled($cropped_image, $src_image,0,0, 0, $_y, $width, $height, $src_w, $hh);
						if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
						imagedestroy($cropped_image);
						imagedestroy($src_image);
						return true;
					}
				}else{
				//缩略图宽小于等于高
					$bili=($height/$width);
					$ww=$src_h/$bili;
					$_x=($src_w-$ww)/2;
					 	if($src_h>$src_w){
							//查找合适剪切的高
							$tem_h=$src_h;
							$tem_w=0;
							while(true){
								$tem_w=($tem_h/$bili);
								if($tem_w<=$src_w){break;}else{$tem_h--;}
							}
							$_x=($src_w-$tem_w)/2;
							$_y=($src_h-$tem_h)/2;
							imagecopyresampled($cropped_image, $src_image,0,0, $_x, 0, $width, $height, $tem_w, $tem_h);
							if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
							imagedestroy($cropped_image);
							imagedestroy($src_image);
							return true;
						}else{
							imagecopyresampled($cropped_image, $src_image,0,0, $_x, 0, $width, $height, $ww, $src_h);
							if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
							imagedestroy($cropped_image);
							imagedestroy($src_image);
							return true;
						}
				}
			}
	}else{
	//源图任意一个长度比缩略图小的情况
		if($src_h<=$height && $src_w<=$width){
			//源图宽高都比缩略图小
			$_x=($width-$src_w)/2;
			$_y=($height-$src_h)/2;
			imagecopyresampled($cropped_image, $src_image,$_x, $_y,0, 0, $src_w, $src_h, $src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}else if($src_h<=$height){
			//源图高比缩略图小
			$hh=$width/($src_w/$src_h);
			$_y=($height-$hh)/2;
			imagecopyresampled($cropped_image, $src_image,0, $_y,0, 0, $width, $src_h, $src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}else{
			//源图宽比缩略图小
			$ww=$height/($src_h/$src_w);
			$_x=($width-$ww)/2;
			imagecopyresampled($cropped_image, $src_image,$_x, 0,0, 0, $src_w, $height,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
	}
}else{
//缩放图片(把源图片完整的缩放到缩略图中)
	//缩略图宽高一样
	if($width==$height){
		//源图宽大于高
		if($src_w>$src_h){
			$ah=$src_h*$width/$src_w;
			$ay=($height-$ah)/2;
			imagecopyresampled($cropped_image, $src_image,0,$ay, 0,0, $width, $ah,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
		//源图宽小于高
		if($src_w<$src_h){
			$aw=$src_w*$height/$src_h;
			$ax=($width-$aw)/2;
			imagecopyresampled($cropped_image, $src_image,$ax,0, 0,0, $aw, $height,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
		//源图宽等于高
		if($src_w==$src_h){
			imagecopyresampled($cropped_image, $src_image,0,0,0, 0, $width, $height,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
	}
	//缩略图宽大于高
	if($width>$height){
		//源图宽大于高
		if($src_w>$src_h){
			$ah=$src_h*$width/$src_w;
			$ay=($height-$ah)/2;
			imagecopyresampled($cropped_image, $src_image,0,$ay, 0,0, $width, $ah,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
		//源图宽小于高
		if($src_w<=$src_h){
			$aw=$src_w*$height/$src_h;
			$ax=($width-$aw)/2;
			imagecopyresampled($cropped_image, $src_image,$ax,0, 0,0, $aw, $height,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
		//源图宽等于高
		//if($src_w==$src_h){
		//	imagecopyresampled($cropped_image, $src_image,0,0,0, 0, $width, $height,$src_w, $src_h);
		//}
	}
	//缩略图宽小于高
	if($width<$height){
		//源图宽小于高
		if($src_w<=$src_h){
			$aw=$src_w*$height/$src_h;
			$ax=($width-$aw)/2;
			imagecopyresampled($cropped_image, $src_image,$ax,0, 0,0, $aw, $height,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}
		//源图宽大于高
		if($src_w>$src_h){
			$ah=$src_h*$width/$src_w;
			$ay=($height-$ah)/2;
			imagecopyresampled($cropped_image, $src_image,0,$ay, 0,0, $width, $ah,$src_w, $src_h);
			if($createimg){$otfunc($cropped_image, $dst_img);}else{$otfunc($cropped_image);}
			imagedestroy($cropped_image);
			imagedestroy($src_image);
			return true;
		}

	}
}
	return true;
}
    </pre>
</div>


<div class="function">
    <a name="imagecreatefrombmp" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/**
 * BMP 创建函数
 * @author simon
 * @param string $filename path of bmp file
 * @example who use,who knows
 * @return resource of GD
 */
function imagecreatefrombmp( $filename ){
    if ( !$f1 = fopen( $filename, "rb" ) )
        return FALSE;
     
    $FILE = unpack( "vfile_type/Vfile_size/Vreserved/Vbitmap_offset", fread( $f1, 14 ) );
    if ( $FILE['file_type'] != 19778 )
        return FALSE;
     
    $BMP = unpack( 'Vheader_size/Vwidth/Vheight/vplanes/vbits_per_pixel' . '/Vcompression/Vsize_bitmap/Vhoriz_resolution' . '/Vvert_resolution/Vcolors_used/Vcolors_important', fread( $f1, 40 ) );
    $BMP['colors'] = pow( 2, $BMP['bits_per_pixel'] );
    if ( $BMP['size_bitmap'] == 0 )
        $BMP['size_bitmap'] = $FILE['file_size'] - $FILE['bitmap_offset'];
    $BMP['bytes_per_pixel'] = $BMP['bits_per_pixel'] / 8;
    $BMP['bytes_per_pixel2'] = ceil( $BMP['bytes_per_pixel'] );
    $BMP['decal'] = ($BMP['width'] * $BMP['bytes_per_pixel'] / 4);
    $BMP['decal'] -= floor( $BMP['width'] * $BMP['bytes_per_pixel'] / 4 );
    $BMP['decal'] = 4 - (4 * $BMP['decal']);
    if ( $BMP['decal'] == 4 )
        $BMP['decal'] = 0;
     
    $PALETTE = array();
    if ( $BMP['colors'] < 16777216 ){
        $PALETTE = unpack( 'V' . $BMP['colors'], fread( $f1, $BMP['colors'] * 4 ) );
    }
     
    $IMG = fread( $f1, $BMP['size_bitmap'] );
    $VIDE = chr( 0 );
     
    $res = imagecreatetruecolor( $BMP['width'], $BMP['height'] );
    $P = 0;
    $Y = $BMP['height'] - 1;
    while( $Y >= 0 ){
        $X = 0;
        while( $X < $BMP['width'] ){
            if ( $BMP['bits_per_pixel'] == 32 ){
                $COLOR = unpack( "V", substr( $IMG, $P, 3 ) );
                $B = ord(substr($IMG, $P,1));
                $G = ord(substr($IMG, $P+1,1));
                $R = ord(substr($IMG, $P+2,1));
                $color = imagecolorexact( $res, $R, $G, $B );
                if ( $color == -1 )
                    $color = imagecolorallocate( $res, $R, $G, $B );
                $COLOR[0] = $R*256*256+$G*256+$B;
                $COLOR[1] = $color;
            }elseif ( $BMP['bits_per_pixel'] == 24 )
                $COLOR = unpack( "V", substr( $IMG, $P, 3 ) . $VIDE );
            elseif ( $BMP['bits_per_pixel'] == 16 ){
                $COLOR = unpack( "n", substr( $IMG, $P, 2 ) );
                $COLOR[1] = $PALETTE[$COLOR[1] + 1];
            }elseif ( $BMP['bits_per_pixel'] == 8 ){
                $COLOR = unpack( "n", $VIDE . substr( $IMG, $P, 1 ) );
                $COLOR[1] = $PALETTE[$COLOR[1] + 1];
            }elseif ( $BMP['bits_per_pixel'] == 4 ){
                $COLOR = unpack( "n", $VIDE . substr( $IMG, floor( $P ), 1 ) );
                if ( ($P * 2) % 2 == 0 )
                    $COLOR[1] = ($COLOR[1] >> 4);
                else
                    $COLOR[1] = ($COLOR[1] & 0x0F);
                $COLOR[1] = $PALETTE[$COLOR[1] + 1];
            }elseif ( $BMP['bits_per_pixel'] == 1 ){
                $COLOR = unpack( "n", $VIDE . substr( $IMG, floor( $P ), 1 ) );
                if ( ($P * 8) % 8 == 0 )
                    $COLOR[1] = $COLOR[1] >> 7;
                elseif ( ($P * 8) % 8 == 1 )
                    $COLOR[1] = ($COLOR[1] & 0x40) >> 6;
                elseif ( ($P * 8) % 8 == 2 )
                    $COLOR[1] = ($COLOR[1] & 0x20) >> 5;
                elseif ( ($P * 8) % 8 == 3 )
                    $COLOR[1] = ($COLOR[1] & 0x10) >> 4;
                elseif ( ($P * 8) % 8 == 4 )
                    $COLOR[1] = ($COLOR[1] & 0x8) >> 3;
                elseif ( ($P * 8) % 8 == 5 )
                    $COLOR[1] = ($COLOR[1] & 0x4) >> 2;
                elseif ( ($P * 8) % 8 == 6 )
                    $COLOR[1] = ($COLOR[1] & 0x2) >> 1;
                elseif ( ($P * 8) % 8 == 7 )
                    $COLOR[1] = ($COLOR[1] & 0x1);
                $COLOR[1] = $PALETTE[$COLOR[1] + 1];
            }else
                return FALSE;
            imagesetpixel( $res, $X, $Y, $COLOR[1] );
            $X++;
            $P += $BMP['bytes_per_pixel'];
        }
        $Y--;
        $P += $BMP['decal'];
    }
    fclose( $f1 );
     
    return $res;
}
    </pre>
</div>

<div class="function">
    <a name="imagebmp" class="mark"></a>
    <pre class="brush:js;toolbar:false">
/** 
* 创建bmp格式图片 
* 
* @author: legend(legendsky@hotmail.com) 
* @link: http://www.ugia.cn/?p=96 
* @description: create Bitmap-File with GD library 
* @version: 0.1 
* 
* @param resource $im          图像资源 
* @param string   $filename    如果要另存为文件，请指定文件名，为空则直接在浏览器输出 
* @param integer  $bit         图像质量(1、4、8、16、24、32位) 
* @param integer  $compression 压缩方式，0为不压缩，1使用RLE8压缩算法进行压缩 
* 
* @return integer 
*/ 
function imagebmp(&$im, $filename = '', $bit = 8, $compression = 0) 
{ 
    if (!in_array($bit, array(1, 4, 8, 16, 24, 32))) 
    { 
        $bit = 8; 
    } 
    else if ($bit == 32) // todo:32 bit 
    { 
        $bit = 24; 
    } 
  
    $bits = pow(2, $bit); 
    
    // 调整调色板 
    imagetruecolortopalette($im, true, $bits); 
    $width  = imagesx($im); 
    $height = imagesy($im); 
    $colors_num = imagecolorstotal($im); 
    
    if ($bit <= 8) 
    { 
        // 颜色索引 
        $rgb_quad = ''; 
        for ($i = 0; $i < $colors_num; $i ++) 
        { 
            $colors = imagecolorsforindex($im, $i); 
            $rgb_quad .= chr($colors['blue']) . chr($colors['green']) . chr($colors['red']) . "\0"; 
        } 
        
        // 位图数据 
        $bmp_data = ''; 
  
        // 非压缩 
        if ($compression == 0 || $bit < 8) 
        { 
            if (!in_array($bit, array(1, 4, 8))) 
            { 
                $bit = 8; 
            } 
  
            $compression = 0; 
            
            // 每行字节数必须为4的倍数，补齐。 
            $extra = ''; 
            $padding = 4 - ceil($width / (8 / $bit)) % 4; 
            if ($padding % 4 != 0) 
            { 
                $extra = str_repeat("\0", $padding); 
            } 
            
            for ($j = $height - 1; $j >= 0; $j --) 
            { 
                $i = 0; 
                while ($i < $width) 
                { 
                    $bin = 0; 
                    $limit = $width - $i < 8 / $bit ? (8 / $bit - $width + $i) * $bit : 0; 
  
                    for ($k = 8 - $bit; $k >= $limit; $k -= $bit) 
                    { 
                        $index = imagecolorat($im, $i, $j); 
                        $bin |= $index << $k; 
                        $i ++; 
                    } 
  
                    $bmp_data .= chr($bin); 
                } 
                
                $bmp_data .= $extra; 
            } 
        } 
        // RLE8 压缩 
        else if ($compression == 1 && $bit == 8) 
        { 
            for ($j = $height - 1; $j >= 0; $j --) 
            { 
                $last_index = "\0"; 
                $same_num   = 0; 
                for ($i = 0; $i <= $width; $i ++) 
                { 
                    $index = imagecolorat($im, $i, $j); 
                    if ($index !== $last_index || $same_num > 255) 
                    { 
                        if ($same_num != 0) 
                        { 
                            $bmp_data .= chr($same_num) . chr($last_index); 
                        } 
  
                        $last_index = $index; 
                        $same_num = 1; 
                    } 
                    else 
                    { 
                        $same_num ++; 
                    } 
                } 
  
                $bmp_data .= "\0\0"; 
            } 
            
            $bmp_data .= "\0\1"; 
        } 
  
        $size_quad = strlen($rgb_quad); 
        $size_data = strlen($bmp_data); 
    } 
    else 
    { 
        // 每行字节数必须为4的倍数，补齐。 
        $extra = ''; 
        $padding = 4 - ($width * ($bit / 8)) % 4; 
        if ($padding % 4 != 0) 
        { 
            $extra = str_repeat("\0", $padding); 
        } 
  
        // 位图数据 
        $bmp_data = ''; 
  
        for ($j = $height - 1; $j >= 0; $j --) 
        { 
            for ($i = 0; $i < $width; $i ++) 
            { 
                $index  = imagecolorat($im, $i, $j); 
                $colors = imagecolorsforindex($im, $index); 
                
                if ($bit == 16) 
                { 
                    $bin = 0 << $bit; 
  
                    $bin |= ($colors['red'] >> 3) << 10; 
                    $bin |= ($colors['green'] >> 3) << 5; 
                    $bin |= $colors['blue'] >> 3; 
  
                    $bmp_data .= pack("v", $bin); 
                } 
                else 
                { 
                    $bmp_data .= pack("c*", $colors['blue'], $colors['green'], $colors['red']); 
                } 
                
                // todo: 32bit; 
            } 
  
            $bmp_data .= $extra; 
        } 
  
        $size_quad = 0; 
        $size_data = strlen($bmp_data); 
        $colors_num = 0; 
    } 
  
    // 位图文件头 
    $file_header = "BM" . pack("V3", 54 + $size_quad + $size_data, 0, 54 + $size_quad); 
  
    // 位图信息头 
    $info_header = pack("V3v2V*", 0x28, $width, $height, 1, $bit, $compression, $size_data, 0, 0, $colors_num, 0); 
    
    // 写入文件 
    if ($filename != '') 
    { 
        $fp = fopen("test.bmp", "wb"); 
  
        fwrite($fp, $file_header); 
        fwrite($fp, $info_header); 
        fwrite($fp, $rgb_quad); 
        fwrite($fp, $bmp_data); 
        fclose($fp); 
  
        return 1; 
    } 
    
    // 浏览器输出 
    header("Content-Type: image/bmp"); 
    echo $file_header . $info_header; 
    echo $rgb_quad; 
    echo $bmp_data; 
    
    return 1; 
} 
    </pre>
</div>

<div class="function">
    <a name="" class="mark"></a>
    <pre class="brush:js;toolbar:false">

    </pre>
</div>

<div class="function">
    <a name="" class="mark"></a>
    <pre class="brush:js;toolbar:false">

    </pre>
</div>

</div>
</div>
</body>
</html>
